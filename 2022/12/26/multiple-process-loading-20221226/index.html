<!doctypehtml><html class="theme-next muse use-motion" lang=zh-CN><meta charset=UTF-8><meta content=IE=edge http-equiv=X-UA-Compatible><meta content=width=device-width,initial-scale=1,maximum-scale=1 name=viewport><meta content=#222 name=theme-color><meta content=no-transform http-equiv=Cache-Control><meta content=no-siteapp http-equiv=Cache-Control><link href=/lib/fancybox/source/jquery.fancybox.css?v=2.1.5 rel=stylesheet><link href=/lib/font-awesome/css/font-awesome.min.css?v=4.6.2 rel=stylesheet><link href=/css/main.css?v=5.1.4 rel=stylesheet><link href=/images/apple-touch-icon-next.png?v=5.1.4 rel=apple-touch-icon sizes=180x180><link href=/images/favicon-32x32-next.png?v=5.1.4 rel=icon sizes=32x32 type=image/png><link href=/images/favicon-16x16-next.png?v=5.1.4 rel=icon sizes=16x16 type=image/png><link color=#222 href=/images/logo.svg?v=5.1.4 rel=mask-icon><meta content=深度学习,分布式训练,集群训练,多进程dataset, name=keywords><meta content=之前在[1]中曾经讨论过在集群中分布式训练大型模型需要一些特别的分布式数据加载器设计，文章最后还讨论了由于分布式多机多卡训练过程中，某个trainer由于数据读取，将会导致其他所有trainer阻塞等待，造成了很大的计算资源浪费的情况。本文针对这种情况，提出一种基于多进程的解法。 name=description><meta content=article property=og:type><meta content=集群深度学习训练实践笔记——多进程Dataset设计 property=og:title><meta content=https://fesianxu.github.io/2022/12/26/multiple-process-loading-20221226/index.html property=og:url><meta content=机器学习杂货铺总店 property=og:site_name><meta content=之前在[1]中曾经讨论过在集群中分布式训练大型模型需要一些特别的分布式数据加载器设计，文章最后还讨论了由于分布式多机多卡训练过程中，某个trainer由于数据读取，将会导致其他所有trainer阻塞等待，造成了很大的计算资源浪费的情况。本文针对这种情况，提出一种基于多进程的解法。 property=og:description><meta content=zh_CN property=og:locale><meta content=https://fesianxu.github.io/2022/12/26/multiple-process-loading-20221226/qrcode.png property=og:image><meta content=https://fesianxu.github.io/2022/12/26/multiple-process-loading-20221226/imgs/sync_dataset.png property=og:image><meta content=https://fesianxu.github.io/2022/12/26/multiple-process-loading-20221226/imgs/async_dataset.png property=og:image><meta content=2022-12-26T15:53:11.000Z property=article:published_time><meta content=2022-12-26T15:56:51.328Z property=article:modified_time><meta content=FesianXu property=article:author><meta content=深度学习 property=article:tag><meta content=分布式训练 property=article:tag><meta content=集群训练 property=article:tag><meta content=多进程dataset property=article:tag><meta content=summary name=twitter:card><meta content=https://fesianxu.github.io/2022/12/26/multiple-process-loading-20221226/qrcode.png name=twitter:image><script id=hexo.configurations>var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };</script><link href=https://FesianXu.github.io/2022/12/26/multiple-process-loading-20221226/ rel=canonical><title>集群深度学习训练实践笔记——多进程Dataset设计 | 机器学习杂货铺总店</title><meta content="Hexo 5.4.2" name=generator><style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container[display="true"] {
  overflow: auto hidden;
}

mjx-container[display="true"] + br {
  display: none;
}</style><body itemscope itemtype=http://schema.org/WebPage lang=zh-CN><div class="container sidebar-position-left page-post-detail"><div class=headband></div><header class=header id=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-wrapper><div class=site-meta><div class=custom-logo-site-title><a class=brand href=/ rel=start> <span class=logo-line-before><i></i></span> <span class=site-title>机器学习杂货铺总店</span> <span class=logo-line-after><i></i></span> </a></div><p class=site-subtitle></div><div class=site-nav-toggle><button><span class=btn-bar></span> <span class=btn-bar></span> <span class=btn-bar></span></button></div></div><nav class=site-nav><ul class=menu id=menu><li class="menu-item menu-item-home"><a href=/ rel=section> <i class="menu-item-icon fa fa-fw fa-home"></i> <br> Home </a><li class="menu-item menu-item-about"><a href=/about/ rel=section> <i class="menu-item-icon fa fa-fw fa-user"></i> <br> About </a><li class="menu-item menu-item-tags"><a href=/tags/ rel=section> <i class="menu-item-icon fa fa-fw fa-tags"></i> <br> Tags </a><li class="menu-item menu-item-categories"><a href=/categories/ rel=section> <i class="menu-item-icon fa fa-fw fa-th"></i> <br> Categories </a><li class="menu-item menu-item-archives"><a href=/archives/ rel=section> <i class="menu-item-icon fa fa-fw fa-archive"></i> <br> Archives </a><li class="menu-item menu-item-search"><a class=popup-trigger href=javascript:;> <i class="menu-item-icon fa fa-search fa-fw"></i> <br> Search </a></ul><div class=site-search><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class=search-icon> <i class="fa fa-search"></i> </span><span class=popup-btn-close> <i class="fa fa-times-circle"></i> </span><div class=local-search-input-wrapper><input autocomplete=off id=local-search-input placeholder=Searching... spellcheck=false></div></div><div id=local-search-result></div></div></div></nav></div></header><main class=main id=main><div class=main-inner><div class=content-wrap><div class=content id=content><div class=posts-expand id=posts><article class="post post-type-normal" itemscope itemtype=http://schema.org/Article><div class=post-block><link href=https://FesianXu.github.io/2022/12/26/multiple-process-loading-20221226/ itemprop=mainEntityOfPage><span hidden itemprop=author itemscope itemtype=http://schema.org/Person> <meta itemprop=name> <meta itemprop=description> <meta content=/%5Bobject%20Object%5D itemprop=image> </span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization> <meta content=机器学习杂货铺总店 itemprop=name> </span><header class=post-header><h1 itemprop="name headline" class=post-title>集群深度学习训练实践笔记——多进程Dataset设计</h1><div class=post-meta><span class=post-time> <span class=post-meta-item-icon> <i class="fa fa-calendar-o"></i> </span> <span class=post-meta-item-text>Posted on</span> <time itemprop="dateCreated datePublished" title="Post created" datetime=2022-12-26T23:53:11+08:00> 2022-12-26 </time> </span><span class=post-category> <span class=post-meta-divider>|</span> <span class=post-meta-item-icon> <i class="fa fa-folder-o"></i> </span> <span class=post-meta-item-text>In</span> <span itemprop=about itemscope itemtype=http://schema.org/Thing> <a href=/categories/%E5%88%86%E5%B8%83%E5%BC%8F%E8%AE%AD%E7%BB%83/ itemprop=url rel=index> <span itemprop=name>分布式训练</span> </a> </span> </span><span class=post-meta-divider>|</span><span class=page-pv><i class="fa fa-file-o"></i> <span class=busuanzi-value id=busuanzi_value_page_pv></span> </span><div class=post-wordcount><span class=post-meta-item-icon> <i class="fa fa-file-word-o"></i> </span><span class=post-meta-item-text>Words count in article:</span><span title="Words count in article"> 16k 字 </span><span class=post-meta-divider>|</span><span class=post-meta-item-icon> <i class="fa fa-clock-o"></i> </span><span class=post-meta-item-text>Reading time ≈</span><span title="Reading time"> 59 mins. 分钟 </span></div></div></header><div class=post-body itemprop=articleBody><p>之前在[1]中曾经讨论过在集群中分布式训练大型模型需要一些特别的分布式数据加载器设计，文章最后还讨论了由于分布式多机多卡训练过程中，某个trainer由于数据读取，将会导致其他所有trainer阻塞等待，造成了很大的计算资源浪费的情况。本文针对这种情况，提出一种基于多进程的解法。 <span id=more></span><div align=right>FesianXu 20211105 at Baidu Search Team</div><h1 id=前言>前言</h1><p>之前在[1]中曾经讨论过在集群中分布式训练大型模型需要一些特别的分布式数据加载器设计，文章最后还讨论了由于分布式多机多卡训练过程中，某个trainer由于数据读取，将会导致其他所有trainer阻塞等待，造成了很大的计算资源浪费的情况。本文针对这种情况，提出一种基于多进程的解法。<strong>如有谬误请联系指出，本文遵循<a href=http://creativecommons.org/licenses/by-sa/4.0/ rel=noopener target=_blank>CC 4.0 BY-SA</a>版权协议，转载请附上原文出处链接和本声明并且联系笔者，谢谢</strong>。<p><span class="math inline"><mjx-container class=MathJax jax=SVG><svg style="vertical-align: -0.075ex;" viewbox="0 -683 833 716" focusable=false height=1.62ex role=img width=1.885ex xmlns=http://www.w3.org/2000/svg><g fill=currentColor stroke=currentColor stroke-width=0 transform=scale(1,-1)><g data-mml-node=math><g data-mml-node=mi><path d="M46 676Q46 679 51 683H781Q786 679 786 676Q786 674 617 326T444 -26Q439 -33 416 -33T388 -26Q385 -22 216 326T46 676ZM697 596Q697 597 445 597T193 596Q195 591 319 336T445 80L697 596Z" data-c=2207 /></g></g></g></svg></mjx-container></span> 联系方式：<p><strong>e-mail</strong>: FesianXu@gmail.com<p><strong>github</strong>: https://github.com/FesianXu<p><strong>知乎专栏</strong>: <a href=https://zhuanlan.zhihu.com/c_1265262560611299328 rel=noopener target=_blank>计算机视觉/计算机图形理论与应用</a><p><strong>微信公众号</strong>：机器学习杂货铺3号店<p><img src=/2022/12/26/multiple-process-loading-20221226/qrcode.png><hr><p>在[1]中最后提出的分布式数据读取方案其实可以看成是某种同步的方案，伪代码如下所示。在当某个trainer耗尽了数据之后，就需要触发<code>dataset.loading_next_part()</code>从而加载下一个part的数据，与此同时，其他所有trainer则会阻塞，导致了大量的计算资源浪费，在笔者实验过程中，某些场景中甚至可能导致<span class="math inline"><mjx-container class=MathJax jax=SVG><svg style="vertical-align: -0.127ex;" viewbox="0 -750 1833 806" focusable=false height=1.824ex role=img width=4.147ex xmlns=http://www.w3.org/2000/svg><g fill=currentColor stroke=currentColor stroke-width=0 transform=scale(1,-1)><g data-mml-node=math><g data-mml-node=mn><path d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z" data-c=35 /><path d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" data-c=30 transform=translate(500,0) /></g><g data-mml-node=mi transform=translate(1000,0)><path d="M465 605Q428 605 394 614T340 632T319 641Q332 608 332 548Q332 458 293 403T202 347Q145 347 101 402T56 548Q56 637 101 693T202 750Q241 750 272 719Q359 642 464 642Q580 642 650 732Q662 748 668 749Q670 750 673 750Q682 750 688 743T693 726Q178 -47 170 -52Q166 -56 160 -56Q147 -56 142 -45Q137 -36 142 -27Q143 -24 363 304Q469 462 525 546T581 630Q528 605 465 605ZM207 385Q235 385 263 427T292 548Q292 617 267 664T200 712Q193 712 186 709T167 698T147 668T134 615Q132 595 132 548V527Q132 436 165 403Q183 385 203 385H207ZM500 146Q500 234 544 290T647 347Q699 347 737 292T776 146T737 0T646 -56Q590 -56 545 0T500 146ZM651 -18Q679 -18 707 24T736 146Q736 215 711 262T644 309Q637 309 630 306T611 295T591 265T578 212Q577 200 577 146V124Q577 -18 647 -18H651Z" data-c=25 /></g></g></g></svg></mjx-container></span>以上的计算资源闲置。<figure class="highlight python"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br></pre><td class=code><pre><span class=line><span class=keyword>class</span> <span class="title class_">DatasetFromCluster</span>(nn.modules.Dataset):</span><br><span class=line>  <span class=keyword>def</span> <span class="title function_">__init__</span>(<span class=params>self, filename_list, random_seed=<span class=number>0</span></span>):</span><br><span class=line>    global_rng = np.random.RandomState(random_seed)</span><br><span class=line>    global_rng.shuffle(filename_list)</span><br><span class=line>    self.trainer_filename_list = [filename, index, filename <span class=keyword>for</span> <span class=built_in>enumerate</span>(filename_list) <span class=keyword>if</span> index % trainer_num == trainer_id]</span><br><span class=line>    self.data_pool = []</span><br><span class=line>    self.loading_next_part()</span><br><span class=line></span><br><span class=line>  <span class=keyword>def</span> <span class="title function_">__getitem__</span>(<span class=params>self, index</span>):</span><br><span class=line>    data = self.data_pool(index)</span><br><span class=line>    <span class=keyword>return</span> self._preprocess(data)</span><br><span class=line>    </span><br><span class=line>	<span class=keyword>def</span> <span class="title function_">loading_next_part</span>(<span class=params>self</span>):</span><br><span class=line>    <span class=string>'''</span></span><br><span class=line><span class=string>    从集群中加载新的数据part，并且用其对self.data_pool进行更新</span></span><br><span class=line><span class=string>    '''</span></span><br><span class=line>    <span class=keyword>pass</span></span><br><span class=line></span><br><span class=line>step = <span class=number>0</span></span><br><span class=line>max_train_step = <span class=number>100</span></span><br><span class=line>model = Model(args, ...)</span><br><span class=line>optim = Adam(args, ...)</span><br><span class=line>dataset = DatasetFromCluster()</span><br><span class=line><span class=keyword>while</span> step < max_train_step:</span><br><span class=line>  dataloader = Dataloader(dataset, num_workers=<span class=number>16</span>, ...)</span><br><span class=line>	<span class=keyword>for</span> datapack <span class=keyword>in</span> dataloader:</span><br><span class=line>    step += <span class=number>1</span></span><br><span class=line>    ...</span><br><span class=line>  dataset.loading_next_part() <span class=comment># 手动触发加载下一个数据part，并且进行新的part的训练。</span></span><br></pre></table></figure><p>解决该问题的关键点在于，之前的同步方案中，整个<code>Dataset</code>只有一个进程，该进程不仅需要负责管理数据池（<code>data_pool</code>）包括将数据从集群上下载和解析，还得负责预处理和<code>__getitem__</code>取值等，一旦某个过程收到阻塞（比如从集群上下载数据），那么整个程序就会被阻塞掉。我们回想到<code>Dataloader</code>的设计中，通过多进程切分了多个<code>worker</code>，去将数据从<code>Dataset</code>中进行拉取和预处理，通过多个进程的并发可以掩盖了某个进程的大量耗时。那么此时，我们也可以在<code>Dataset</code>中设计两类进程，一个进程就是<code>Dataset</code>本身，用于管理数据和封装数据接口，方便<code>Dataloader</code>接入和取值，我们称该进程为<code>data_manager</code>；还有另一类进程负责从集群中拉取数据和解析，并且将数据入队列（<code>Enqueue</code>），我们称该进程为<code>data_worker</code>。该队列（<code>Data Queue</code>）用于管理所有数据，其中每个数据单元<code>item</code>就是之前方案中所说的<code>data_pool</code>，也就是集群里面的一个part。这个方案可以视为是异步<code>Dataset</code>数据读取器，同步和异步数据读取的差别可见Fig 1.和Fig 2.所示，后者的<code>Data worker</code>的功能可由多个进程或者线程承载。一旦<code>Data queue</code>状态不为满（<code>Full</code>）的时候，就由一个或者多个<code>data worker</code>从集群中加载数据并且进行入队，如果状态为满，那么就阻塞当前所有的<code>data worker</code>。当某个trainer的数据消耗完后，如果<code>Data queue</code>状态为空(<code>Empty</code>)，那么就阻塞trainer，发起<code>data worker</code>从集群中拉取新的数据，如果不为空就从<code>Data Queue</code>中出队（<code>Dequeue</code>）一个新的数据作为<code>Data Pool</code>用于训练。<p>考虑到多进程的<code>data worker</code>读取数据并且入队需要重新对<code>filelist</code>进行互斥切分，并且在实践中一个<code>data worker</code>就足以应对绝大多数情况，我们一般采用一个<code>data worker</code>就足够了。那么以上流程的伪代码可见如下。<p><img alt=sync_dataset src=/2022/12/26/multiple-process-loading-20221226/imgs/sync_dataset.png><div align=center><b> Fig 1. 同步数据加载方式，Data Pool和Cluster之间的数据交互通过同步形式进行，一旦该处收到阻塞，那么整个数据处理和模型训练将会收到阻塞。 </b></div><p><img alt=async_dataset src=/2022/12/26/multiple-process-loading-20221226/imgs/async_dataset.png><div align=center><b> Fig 2. 异步数据加载方式，Data Pool来自于数据队列里出队的结果，而数据队列由多个Data worker进行异步加载，每个Data worker由一个进程或者线程承载。 </b></div><figure class="highlight python"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br></pre><td class=code><pre><span class=line><span class=keyword>from</span> multiprocessing <span class=keyword>import</span> Queue, Process</span><br><span class=line><span class=keyword>class</span> <span class="title class_">MultiprocessDataset</span>(nn.modules.Dataset):</span><br><span class=line>  <span class=keyword>def</span> <span class="title function_">__init__</span>(<span class=params>self, filename_list, queue_size=<span class=number>4</span>, random_seed=<span class=number>0</span></span>):</span><br><span class=line>    global_rng = np.random.RandomState(random_seed)</span><br><span class=line>    global_rng.shuffle(filename_list)</span><br><span class=line>    self.trainer_filename_list = [filename, index, filename <span class=keyword>for</span> <span class=built_in>enumerate</span>(filename_list) <span class=keyword>if</span> index % trainer_num == trainer_id]</span><br><span class=line>    </span><br><span class=line>    self.cur_data_pool = []</span><br><span class=line>    self.data_queue = Queue(maxsize=queue_size)</span><br><span class=line>    self.datapart_index = <span class=number>0</span></span><br><span class=line>    self.data_load_processor = Process(target=self._load_from_cluster, args=(self.data_queue, <span class=number>0</span>))</span><br><span class=line>    self.data_load_processor.start()</span><br><span class=line>    <span class=built_in>print</span>(<span class=string>"end of all data feeder"</span>)</span><br><span class=line>  </span><br><span class=line>  <span class=keyword>def</span> <span class="title function_">_load_from_cluster</span>(<span class=params>self, data_queue, task_id</span>):</span><br><span class=line>    <span class=string>"""</span></span><br><span class=line><span class=string>    load data from cluster, and enqueue the data_queue.</span></span><br><span class=line><span class=string>    """</span></span><br><span class=line>    <span class=keyword>while</span> <span class=literal>True</span>:</span><br><span class=line>      <span class=keyword>if</span> <span class=keyword>not</span> self.data_queue.full():</span><br><span class=line>      	data_pool = load_data()</span><br><span class=line>        self.data_queue.put(obj=data_pool)</span><br><span class=line>  </span><br><span class=line>  <span class=keyword>def</span> <span class="title function_">pop_datapool</span>(<span class=params>self</span>):</span><br><span class=line>    self.data_pool = self.data_queue.get()</span><br><span class=line> </span><br><span class=line>  <span class=keyword>def</span> <span class="title function_">get_queue_size</span>(<span class=params>self</span>):</span><br><span class=line>    <span class=keyword>return</span> self.data_queue.qsize()</span><br><span class=line>  </span><br><span class=line>  <span class=keyword>def</span> <span class="title function_">__len__</span>(<span class=params>self</span>):</span><br><span class=line>    <span class=keyword>return</span> <span class=built_in>len</span>(self.data_pool)</span><br><span class=line>  </span><br><span class=line>  <span class=keyword>def</span> <span class="title function_">__getitem__</span>(<span class=params>self, index</span>):</span><br><span class=line>    data = self.data_pool[index]</span><br><span class=line>    <span class=keyword>return</span> preprocess(data)</span><br><span class=line></span><br><span class=line></span><br><span class=line>dataset = MultiprocessDataset(args, ...)</span><br><span class=line>step = <span class=number>0</span></span><br><span class=line>max_train_step = <span class=number>100</span></span><br><span class=line>model = Model(args, ...)</span><br><span class=line>optim = Adam(args, ...)</span><br><span class=line><span class=keyword>while</span> step < max_train_step:</span><br><span class=line>	load_begin = time.clock()</span><br><span class=line>  dataset.pop_datapool()</span><br><span class=line>  load_end = time.clock()</span><br><span class=line>  <span class=built_in>print</span>(<span class=string>"load data time = [{}]"</span>.<span class=built_in>format</span>(load_end - load_begin))</span><br><span class=line>  dataloader = Dataloader(dataset, num_workers=<span class=number>16</span>, ...)</span><br><span class=line>	<span class=keyword>for</span> datapack <span class=keyword>in</span> dataloader:</span><br><span class=line>    step += <span class=number>1</span></span><br><span class=line>    data, label = datapack</span><br><span class=line>    ...</span><br><span class=line>    logit = Model(data)</span><br><span class=line>    loss = loss(logit, label)</span><br><span class=line>    loss.backward()</span><br><span class=line>    optim.step()</span><br><span class=line>    optim.clear_grad()</span><br><span class=line>    </span><br></pre></table></figure><h1 id=reference>Reference</h1><p>[1]. https://fesian.blog.csdn.net/article/details/121146854</div><div><ul class=post-copyright><li class=post-copyright-author><strong>Post author:</strong> FesianXu<li class=post-copyright-link><strong>Post link:</strong> <a href=https://fesianxu.github.io/2022/12/26/multiple-process-loading-20221226/ title=集群深度学习训练实践笔记——多进程Dataset设计>https://fesianxu.github.io/2022/12/26/multiple-process-loading-20221226/</a><li class=post-copyright-license><strong>Copyright Notice: </strong> All articles in this blog are licensed under <a rel="external nofollow" href=https://creativecommons.org/licenses/by-nc-sa/3.0/ target=_blank>CC BY-NC-SA 3.0</a> unless stating additionally.</ul></div><footer class=post-footer><div class=post-tags><a href=/tags/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/ rel=tag># 深度学习</a><a href=/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E8%AE%AD%E7%BB%83/ rel=tag># 分布式训练</a><a href=/tags/%E9%9B%86%E7%BE%A4%E8%AE%AD%E7%BB%83/ rel=tag># 集群训练</a><a href=/tags/%E5%A4%9A%E8%BF%9B%E7%A8%8Bdataset/ rel=tag># 多进程dataset</a></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/2022/12/26/eff-large-scale-train-20221226/ rel=next title=集群深度学习训练实践笔记——分布式数据读取器> <i class="fa fa-chevron-left"></i> 集群深度学习训练实践笔记——分布式数据读取器 </a></div><span class=post-nav-divider></span><div class="post-nav-prev post-nav-item"><a title="【SVM笔记系列之一】 SVM的目的和起源" href=/2022/12/27/svm-series-1-20221226/ rel=prev> 【SVM笔记系列之一】 SVM的目的和起源 <i class="fa fa-chevron-right"></i> </a></div></div></footer></div></article><div class=post-spread></div></div></div></div><div class=sidebar-toggle><div class=sidebar-toggle-line-wrap><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside class=sidebar id=sidebar><div class=sidebar-inner><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target=post-toc-wrap>Table of Contents<li class=sidebar-nav-overview data-target=site-overview-wrap>Overview</ul><section class="site-overview-wrap sidebar-panel"><div class=site-overview><div class="site-author motion-element" itemprop=author itemscope itemtype=http://schema.org/Person><img alt class=site-author-image itemprop=image src=/%5Bobject%20Object%5D><p class=site-author-name itemprop=name><p class="site-description motion-element" itemprop=description></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href=/archives/%7C%7C%20archive> <span class=site-state-item-count>100</span> <span class=site-state-item-name>posts</span> </a></div><div class="site-state-item site-state-categories"><a href=/categories/index.html> <span class=site-state-item-count>31</span> <span class=site-state-item-name>categories</span> </a></div><div class="site-state-item site-state-tags"><a href=/tags/index.html> <span class=site-state-item-count>173</span> <span class=site-state-item-name>tags</span> </a></div></nav><div class="links-of-author motion-element"><span class=links-of-author-item> <a href=https://github.com/FesianXu target=_blank title=GitHub> <i class="fa fa-fw fa-github"></i>GitHub</a> </span><span class=links-of-author-item> <a href=mailto:FesianXu@gmail.com target=_blank title=E-Mail> <i class="fa fa-fw fa-envelope"></i>E-Mail</a> </span><span class=links-of-author-item> <a href=https://stackoverflow.com/users/7348519/fesianxu target=_blank title=StackOverflow> <i class="fa fa-fw fa-stack-overflow"></i>StackOverflow</a> </span></div></div></section><!--noindex--><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class=post-toc><div class=post-toc-content><ol class=nav><li class="nav-item nav-level-1"><a class=nav-link href=#%E5%89%8D%E8%A8%80><span class=nav-number>1.</span> <span class=nav-text>前言</span></a><li class="nav-item nav-level-1"><a class=nav-link href=#reference><span class=nav-number>2.</span> <span class=nav-text>Reference</span></a></ol></div></div></section><!--/noindex--></div></aside></div></main><footer class=footer id=footer><div class=footer-inner><div class=copyright>© <span itemprop=copyrightYear>2024</span><span class=with-love> <i class="fa fa-user"></i> </span><span class=author itemprop=copyrightHolder>FesianXu</span></div><div class=“theme-info”><div class=“powered-by”></div><span class=“post-count”> 该站点文章共379k字，欢迎光临~ </span></div><script async src=https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><div class=busuanzi-count><script async src=https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js></script><span class=site-uv> <i class="fa fa-user"></i> <span class=busuanzi-value id=busuanzi_value_site_uv></span> </span><span class=site-pv> <i class="fa fa-eye"></i> <span class=busuanzi-value id=busuanzi_value_site_pv></span> </span></div></div></footer><div class=back-to-top><i class="fa fa-arrow-up"></i></div></div><script>if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }</script><script src=/lib/jquery/index.js></script><script src=/lib/fastclick/lib/fastclick.min.js></script><script src=/lib/jquery_lazyload/jquery.lazyload.js></script><script src=/lib/velocity/velocity.min.js></script><script src=/lib/velocity/velocity.ui.min.js></script><script src=/lib/fancybox/source/jquery.fancybox.pack.js></script><script src=/js/src/utils.js></script><script src=/js/src/motion.js></script><script src=/js/src/scrollspy.js></script><script src=/js/src/post-details.js></script><script src=/js/src/bootstrap.js></script><script>// Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.json";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });</script><script src=/live2dw/lib/L2Dwidget.min.js></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"left","width":150,"height":300},"mobile":{"show":true},"react":{"opacity":0.7}});</script>